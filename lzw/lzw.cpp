#include <core/pch.hpp>
#include <core/noncopyable.hpp>

#include <streams/stream.hpp>

#include <streams/io_stream.hpp>

#include <streams/input_stream.hpp>
#include <streams/output_stream.hpp>

#include <streams/data_provider.hpp>
#include <streams/file_data_provider.hpp>
#include <streams/icu_file_data_provider.hpp>

#include <streams/input_byte_stream.hpp>
#include <streams/output_byte_stream.hpp>

#include <streams/input_bit_stream.hpp>
#include <streams/output_bit_stream.hpp>

#include <streams/input_codepoint_stream.hpp>
#include <streams/output_codepoint_stream.hpp>

#include <streams/input_string_stream.hpp>
#include <streams/output_string_stream.hpp>

#include <lzw/model.hpp>
#include <lzw/binary_model.hpp>
#include <lzw/codec.hpp>

USINGNAMESPACE(compression)

int main()
{
    //auto *test_data = L"1010011101111001010011110110101000011011001000011011101110010001101101001001111100100111101111111001111000010101011001111101010110111010110111110101101110101110101011110110000111000101101111110000110011101100101101100100101111001011111010011100100101101011111001101101011";
    auto *test_data = L"030600003300033021210210003012330031010102400033030213303011000002010110000200060020010000602531151004010220110011412002000003021003000001";
    //auto *test_data = L"0121182001000130113001000000000002102300110203440001001103130310112110020205030100003011250000011004000101000810010103001100021010002100201800012010";
    //auto *test_data=L"261100003001001000010301310001421500202300032203002000000010111020110220100220331403100000001500300202130004020101100004001220110210024142002301401017221020020102023100000033022001300102001040001112000500122516000021000011201102020000101012021201100303000210140000000003230510011001001300301000003020000000103021332111000025251000110100030312051030000010211000002000101101130300210010001000012002001401221001010000200200000002003020200011020034101600121021012014100210101000300031000001000210040013001101440811011302011810001103120110301100031001020100120223110020152022020010010010000200301401000130100103430400100010020201001100010013001200002100020001002141010300052042100012320010213108010003000911001201000310212220000410011100020000010200211221100017201011040010100001100030001100040112000010110200021101120001000100200212102003100400112112034100130001111300040100030003321010020011000202000031000002011218010410200003000011101000121003100000333002003105170201011210120011100001010000230202003011301310000021200320020003210001203100000101013423423011102400032011000000000002000000001010100300001101000101210610120302020100040100350101031400100012100231122010133200011122131001250110002101016150012013001410211100000200011100020240120000010001001010012000000142242020110110010100540206021200010000120200116000001500135012710002111535101200103220161020110114111300200301000301000040010000020004020000150114112100100040030010";
    //auto *test_data = L"101040030010000100301000020010101003001010000101005010100403020204010000000201010010020000020501002050";
    //auto *test_data = L"363333212121312333111243332133311211126216253115141221111412232131";
    //auto *test_data = L"00161121004001060011031021010000110130120001002141003400110100201001111011000000610011000064000130010210200032400220000020200211410100102121000001125200301002501000201450010000101000121010301023303201211002000031030220100030040042014023100201001020400030110120002000300320201201200024101162000500200062300534300201500000200001111110201010010102002000134100101001210112220000103102022222002120032020002000005210000530036235401010430000102000003113100330110302210010000021010100003101004001110102101000000300000012112020320001031020000100103031000162800112010110200012100141011000230003040001000301041120101022011000000120005201021003500012110010440012412010001311101103100022115101021101000000010111101101010003010000000110200000112100100011002101120010004101004510001130011007101001302012001070000103020120000700000000002400201010111001020101011012003021204000022320130201110002000200011401030000022100000100202033014041313012012003220000001101000000000121002002010101261230017000060000100101000000100320010004301840010300040011001010022000004100300400511231003040001206000012203212031001030010000013010002201700000300001012220001000000000512012122001001002100210110100101042220030101410020010201000002020021011004002204080100000414000300022000201011100100000001000001131221010213000300340000232210100210010101020351001431012100211300000600200010210001411010010300012000000103012402001100011500302701000000003102115001000101620201050052011300001101110011010000100010000121300200210000003003112000000003340501521002104200201011001020412001010110011120010013001000000020300020300000020101110010401400201011010210110010003100011020002000000110201100105111110453221100000000010102000501001020100100200000214000051240114100100050022001012010002001006011100221212000102040010081300000310110200012013300124121300002112430110020000201100002001010102003002032011002010012001011020000000021002220000000010250200001020100000002131110211002000100320100100020301111311000111023102131202120401000000110301001200010120132001200200303122001721041411022318020300001001321001000002052040021430010100210231041100050105010101110220100103012321132003013011002201240000000410112132001208132300100101001010060001100031031011001021011312123310030222010210010104003111040031000001001011010013010012102210070120000000120210031110300100022000032200000000001001512021000000014001001000100110011000100313110201102201010003230300220000110015000200000123300401020000010701000002010002200000210212021000100112012401032020241003010223020002042221310201404011201200000203001020111100010000021000010110000142701000102001024100000311100000210001001010202020020020210102104000002010002120101002013003000013017042000000635040010010010160001011100100010004130010014201021010020031220000010011000000100050001001411130000212710001001100100030002220002141001010002501102203000032210010121001002011101010010052502101010010002000111100200312400000110012000003622100122403011210103000010103001215102000020100001020300121501011211000001112141100103001201000120000000000101241013000211301101000111202221102101300105010002030010021121000000010030010400003002021003300010430000110120101002030000210211000203000403003201240000000700002107012100200100100803201100010005030000000904100210310102022105001130020003060000026000001001031200000001100000000000411011031120101460000000000001112010900050100000402103161021012001420040000002130040110030000030100000000001230001000132223201202000206102103000002000202001130010001413400000000100013002040030030110100014003220200001200000140322210040000110100000110003400001311001111032111121012012350000104001100101020220051300100030022011003062203120015000013001101100010200009222203030011022200011023001111001003010100100101020010041003010000103202001010010103001002112100000001310401010001101250111020012164120000132131010303110130020002052101010000210211011000100600014100030002100002040023000102040112220322200361020200111300101302041302103401050220101020110100502121233321110102120101411121061116005400210111100001002001000121150141410161011100103101003001011201000100300000002210010312020000100000010001203430210004000121001000012010004000130210210101000000040000210301231002040012100004212000000003400201111001010000001102050210000021200002201201000114030100104100100111010001120011000032150100000214410012000111102011040000003000030201111001011000030113110121001502100041010218011001011002131021000810100111010002100101022400000023301200051001021012000101000122105010102100010112100100000340103021520010202002011100000100511222002005202110001000000001200020603301202000122000402100002211502010023100050000310021313211020120200013200100201122010031020000002010022000000050000001040100001010041010420012102110102011001050100010006002103100004212013030110330020002240000102130053200202020132230201010012223011001001111031201322061201020200002000100100200220031301010106082010020002000320100302020011101300201003001100300001100800101000003020020013201200010014000012111700011001011010011000020000002100002000010202001421010312032002202113072030021000040103201102121701030310050010000111132011241116004701021102012391102000001000005100110100110001000311001110000205024041000113200002010202130002340000111012021100000141010010310003100024310101004111002300101010422340021003401201012030000200200401301110010000000003100011014101000010003000100702001000111103230138131004004120101000210000030020142200301041001042010200100010000200030000130110201130072100012015100525020001101110020123000102012020100002011042011300002202431114010141313012010111001104120012005002533120730010120200001200200100000000000001100103020012101001000100030013121100101120143111300010000010100001110210208001010201103404100012011034021231000030130000341231010210132100100211011000021110012205301110020000710310301021102040001001342120211500002101003010310021314100020330310050021020300030201001001000000211103010002131221014021200003060003001010110311210113000000000000011000102010001010000010230111002310011010000012020001070330";

    using integer_type = uint32_t;
    using model_type = lzw::binary_model<char_type, integer_type, string_type, uint16_t>;

    {
        std::shared_ptr<model_type> model(std::make_shared<model_type>());

        //(*model).codes().emplace(L"1",      0);
        //(*model).codes().emplace(L"11",     1);
        //(*model).codes().emplace(L"111",    2);
        //(*model).codes().emplace(L"2",      3);
        //(*model).codes().emplace(L"12",     4);
        //(*model).codes().emplace(L"21",     5);
        //(*model).codes().emplace(L"3",      6);
        //(*model).codes().emplace(L"4",      7);
        //(*model).codes().emplace(L"5",      8);
        //(*model).codes().emplace(L"6",      9);


        (*model).codes().emplace(L"0",      0);
        (*model).codes().emplace(L"1",      1);
        (*model).codes().emplace(L"00",     2);
        (*model).codes().emplace(L"01",     3);
        (*model).codes().emplace(L"10",     4);
        (*model).codes().emplace(L"000",    5);
        (*model).codes().emplace(L"001",    6);
        (*model).codes().emplace(L"010",    7);
        (*model).codes().emplace(L"100",    8);
        (*model).codes().emplace(L"110",    9);
        (*model).codes().emplace(L"111",    10);
        (*model).codes().emplace(L"0000",   11);
        (*model).codes().emplace(L"2",      12);
        (*model).codes().emplace(L"02",     13);
        (*model).codes().emplace(L"20",     14);
        (*model).codes().emplace(L"4",      15);
        (*model).codes().emplace(L"5",      16);
        (*model).codes().emplace(L"6",      17);
        (*model).codes().emplace(L"7",      18);
        (*model).codes().emplace(L"8",      19);
        (*model).codes().emplace(L"9",      20);

        //(*model).codes().emplace(L"0",      0);
        //(*model).codes().emplace(L"1",      1);
        //(*model).codes().emplace(L"00",     2);
        //(*model).codes().emplace(L"01",     3);
        //(*model).codes().emplace(L"10",     4);
        //(*model).codes().emplace(L"11",     5);
        //(*model).codes().emplace(L"001",    6);
        //(*model).codes().emplace(L"010",    7);
        //(*model).codes().emplace(L"100",    8);
        //(*model).codes().emplace(L"110",    9);
        //(*model).codes().emplace(L"111",    10);
        //(*model).codes().emplace(L"0000",   11);
        //(*model).codes().emplace(L"1111",   12);
        //(*model).codes().emplace(L"00000",  13);
        //(*model).codes().emplace(L"11111",  14);
        //(*model).codes().emplace(L"000000", 15);
        //(*model).codes().emplace(L"111111", 16);
        //(*model).codes().emplace(L"2",      17);
        //(*model).codes().emplace(L"22",     18);
        //(*model).codes().emplace(L"3",      19);
        //(*model).codes().emplace(L"4",      20);
        //(*model).codes().emplace(L"5",      21);
        //(*model).codes().emplace(L"6",      22);
        //(*model).codes().emplace(L"7",      23);
        //(*model).codes().emplace(L"8",      24);
        //(*model).codes().emplace(L"9",      25);

        using input_stream_type = input_string_stream<char_type>;
        std::shared_ptr<input_stream_type> input_stream(std::make_shared<input_stream_type>(test_data));

        for(const auto& ch : (*input_stream).data())
        {
            std::wcout << ch << L' ';
        }
        std::wcout << L':' << (*input_stream).data().size() << std::endl;
        //std::wcout << (*input_stream).data() << L':' << (*input_stream).data().size() << std::endl;

        //using output_stream_type = output_string_stream<file_data_provider>;
        //string_type file_name(LR"(d:\tmp\lzw.txt)");
        //auto fdp(std::make_shared<file_data_provider>(file_name, L"w+b"));
        //std::shared_ptr<output_stream_type> output_stream(std::make_shared<output_stream_type>(fdp));

        using output_stream_type = output_string_stream<char_type>;
        std::shared_ptr<output_stream_type> output_stream(std::make_shared<output_stream_type>());

        lzw::codec<char_type, integer_type, string_type, uint16_t, input_stream_type, output_stream_type> lzwc;

        std::size_t original_size;
        std::size_t encoded_size;

        bool rc1 = lzwc.encode(model, input_stream, output_stream, original_size, encoded_size);

        //(*fdp).rewind();
        //uint16_t code;
        //while((*fdp).get(code))
        //{
        //    std::cout << std::to_string(code) << ' ';
        //}
        for(auto ch : (*output_stream).data())
        {
            std::cout << ch << ' ';
        }
        std::wcout << std::endl;

        std::wcout << L"ORG:" << original_size << std::endl;
        std::wcout << L"ENC:" << encoded_size << std::endl << std::endl;

        std::vector<std::pair<string_type, uint16_t>> elems((*model).codes().begin(), (*model).codes().end());
        std::sort(elems.begin(), elems.end(), [](const auto& kvp1, const auto& kvp2)
        {
            return kvp1.second < kvp2.second;
        });

        for(const auto& kvp : elems)
        {
            std::wcout << kvp.first.c_str() << L',' << std::to_wstring(kvp.second) << std::endl;
        }

        //(*fdp).rewind();
    }
    {
        std::shared_ptr<model_type> model(std::make_shared<model_type>());

        (*model).codes().emplace(L"0", 0);
        (*model).codes().emplace(L"1", 1);
        //(*model).codes().emplace(L"2", 2);
        //(*model).codes().emplace(L"3", 3);
        //(*model).codes().emplace(L"4", 4);
        //(*model).codes().emplace(L"5", 5);
        //(*model).codes().emplace(L"6", 6);
        //(*model).codes().emplace(L"7", 7);
        //(*model).codes().emplace(L"8", 8);
        //(*model).codes().emplace(L"9", 9);

        using input_stream_type = input_byte_stream<file_data_provider>;
        string_type file_name(LR"(d:\tmp\lzw.txt)");
        auto fdp(std::make_shared<file_data_provider>(file_name, L"rb"));
        std::shared_ptr<input_stream_type> input_stream(std::make_shared<input_stream_type>(fdp));

        using output_stream_type = output_string_stream<char_type>;
        std::shared_ptr<output_stream_type> output_stream(std::make_shared<output_stream_type>());

        lzw::codec<char_type, integer_type, string_type, uint16_t, input_stream_type, output_stream_type> lzwc;

        std::size_t original_size;

        bool rc2 = lzwc.decode(model, input_stream, output_stream, original_size);
        std::wcout << (*output_stream).data() << L':' << (*output_stream).data().size() << std::endl;

        std::wcout << (rc2 && (test_data == (*output_stream).data()) ? L"ok" : L"error") << std::endl << std::endl;
    }
}


// 030600003300033021210210003012330031010102400033030213303011000002010110000200060020010000602531151004010220110011412002000003021003000001
// 10104   003  00100001003  0100002 0010101003  001010000101005    0101004   03  02 02 04   0100000002 0101001002 000002 05    01002 05    0
//  3 6    33   33 2121 21   3 1233  31 1 1 24   33 3 2133 3 11     2 1 11    2   6  2  1    6 2531151  4 1 22 11  11412  2     3 21  3     1

// 101040030010000100301000020010101003001010000101005010100403020204010000000201010010020000020501002050
// 363333212121312333111243332133311211126216253115141221111412232131

// 363333212121312333111243332133311211126216253115141221111412232131
// 0000000101010100003  00000010002 03  000100002 0101004   010000101
// 3633332 2 2 3 2333   243332 333  2   262 6253  5 4 22    4 2232 3

// 36333322232333243332333226262535422422323
// 0000003  010001000010002 010100002 02 010
// 363333   3 333 4333 333  6 6 5354  4  3 3



//101040030010000100301000020010101003001010000101005010100403020204010000000201010010020000020501002050000000010101010000300000010002030001000020101004010000101000000301000100001000201010000202010
//11431131211131111511432241211122512511113123121141113111211221



//146
//11120120331011100000200000140014001122032104011523021021011010010002010001201310020001010120041211330201600201220120007311100000170020012201100101
//  65 0.445
//  43 0.294
//  22 0.150
//   8 0.054
//   4 0.027
//     0.003
//
//0.445 0.294 0.150 0.054 0.027
//
//Entropy
//https://planetcalc.com/2476/
// https://planetcalc.com/9069/


